<%# @survey.inspect %>
<div id="loading_overlay" style="outline:2px solid red;">
    <div class="spinner"></div>
    <p class="text"><%= t('.saving_your_survey_message') %></p>
</div>
<div class="container">
  <header id="backBtnContainer">
    <h2 class="left">
      <a href="/surveys" class="backBtn"></a>
      <span>
        <!--<%= t('.list_of_users_heading', :survey_name => @survey.name) %>-->
        Survey  builder
        <!-- <span class="subHeading">
          <%= @survey.name %>
        </span> -->
      </span>
    </h2>
  </header>
  
  <div class="blue_tabs">
    <ul class="tab-links">
      <li class="active">
        <%= link_to  t('edit'), survey_build_path(@survey.id) if can? :build, @survey %>
      </li>
      <li><%= link_to t("overview"), survey_dashboard_index_path(@survey.id) if can?(:view_survey_dashboard, @survey) %></li>
      <li>
        <%= link_to t("Responses"), survey_responses_path(@survey.id)  if can?(:read, @survey) %>
      </li>
      <li>
        <%= link_to t('reports'), report_survey_path(@survey.id) if can?(:report, @survey) && @survey.finalized? %>
      </li>
    </ul>
  </div>
  <div style="padding:15px;" class="survey_option_btns">
    <!-- <a href="#" class="Btn colrBtn right">delete</a>
    <a href="#" class="Btn colrBtn right inline-btn">publish</a>-->
    <%= link_to t(".delete"), survey_path(@survey.id), :method => :delete, :class=>"Btn colrBtn  right inline-btn button delete-survey", :data => { :confirm => t(:confirm) } if can? :destroy, @survey %>
    
    <%= button_tag t(".finalize_survey"), :id => 'finalize', :class => "button right inline-btn" if can? :finalize, @survey %>
    <%= button_to '', survey_finalize_path(@survey.id), :method => :put, :class => 'hidden', :id => 'finalize_hidden' if can? :finalize, @survey %>
    <%# button_tag t(".finalize_survey"), :id => 'finalize', :class => "Btn colrBtn right inline-btn" if can? :finalize, @survey %>
    <%# button_to '', survey_finalize_path(@survey.id), :method => :put, :class => 'hidden', :id => 'finalize_hidden' if can? :finalize, @survey %>
    
    

 <!-- <a href="#" class="Btn colrBtn right inline-btn">save</a> -->
    <input id ="save" type="button" class="right inline-btn" value="Save"></input>
    <div class="clear"></div>
  </div>
  <div class="builder-survey-info">
    <div class="builder-survey-name-info">
      <form action="">
        <input id="organization_name" name="organization[name]" type="text" 
      value="<%= @survey.name %>"/>
        <textarea id="my_org_description" name="organization[about]" placeholder="Write about your organization here" rows="auto"><%= @survey.description %></textarea>
      </form>
    </div>
    <%= semantic_form_for @survey, :url => survey_publication_path(@survey.id), :method => :put do |f| %>
    <div class="survey_sideInfo">
      <div class="expiresOn">Expires on -
      <%# f.input :expiry_date, :as => :string, :required => true, :input_html => { :value => @survey.expiry_date, :class => 'expiry-date'  }, :label => false %>
      <%# f.input :expiry_date, :id => "expiry_date" ,:as => :string, :required => false, :input_html => { :value => @survey.expiry_date, :class => 'expiry-date' } %>
      <input id="expiry_date" type="text" name="expiry_date" value="<%= @survey.expiry_date %>"></input>
      </div>
    <% end  %>
      <div class="questionBox">
        <header>Questions</header>
        <table>
          <tr>
              <td><span class="clsass_main_questions" >05</span>&nbsp;&nbsp;Main</td>
              <td><span class="clsass_sub_questions">10</span>&nbsp;&nbsp;Sub</td>
            </tr>         
        </table>
      </div>
      <div class="clear"></div>
      <a href="#" class="collapseAll-btn">Collapse all</a>
    </div>
    <div class="clear"></div>
  </div>
  <form>
    <div class="survey-builder">
      <!--question row-->
      <div class="clear"></div>
    </div><!--survey builder ends-->
    <div class="addQuestion">
      <!--add question btn-->
      <div class="question-types">
        <ul>
          <li>
            <!-- <input type="radio" name="questionType" id="singleLine" class="regular-radio">
            <label for="singleLine" class=""></label> -->
            <span><a href="javascript:void(0)" id="SingleLineQuestion" class="clsaddquestion">Single Line</a></span>
          </li>
          <li>
            <!-- <input type="radio" name="questionType" id="numeric" class="regular-radio ">
            <label for="numeric" class=""></label> -->
            <span><a href="javascript:void(0)" id="NumericQuestion" class="clsaddquestion">Numeric</a></span>
          </li>
          <li>
            <!-- <input type="radio" name="questionType" id="multiline" class="regular-radio">
            <label for="multiline" class=""></label> -->
            <span><a href="javascript:void(0)" id="MultilineQuestion" class="clsaddquestion">Multiline</a></span>
          </li>
          <li>
            <!-- <input type="radio" name="questionType" id="date" class="regular-radio">
            <label for="date" class=""></label> -->
            <span><a href="javascript:void(0)" id="DateQuestion" class="clsaddquestion">Date</a></span>
          </li>
          <li>
            <!-- <input type="radio" name="questionType" id="multichoice" class="regular-radio">
            <label for="multichoice" class=""></label> -->
            <span><a href="javascript:void(0)" id="MultiChoiceQuestion" class="clsaddquestion">Multichoice</a></span>
          </li>
          <li>
            <!-- <input type="radio" name="questionType" id="category" class="regular-radio">
            <label for="category" class=""></label> -->
            <span><a href="javascript:void(0)" id="CategoryQuestion" class="clsaddquestion">Category</a></span>
          </li>
          <li>
            <!-- <input type="radio" name="questionType" id="rating" class="regular-radio">
            <label for="rating" class=""></label> -->
            <span><a href="javascript:void(0)" id="RatingQuestion" class="clsaddquestion">Rating</a></span>
          </li>
          <li>
            <!-- <input type="radio" name="questionType" id="multiRecord" class="regular-radio">
            <label for="multiRecord" class=""></label> -->
            <span><a href="javascript:void(0)" id="MultiRecordCategory" class="clsaddquestion">Multirecord</a></span>
          </li>
          <li>
            <!-- <input type="radio" name="questionType" id="radio" class="regular-radio">
            <label for="radio" class=""></label> -->
            <span><a href="javascript:void(0)" id="RadioQuestion" class="clsaddquestion">Radio</a></span>
          </li>
          <li>
            <!-- <input type="radio" name="questionType" id="photo" class="regular-radio">
            <label for="photo" class=""></label> -->
            <span><a href="javascript:void(0)" id="PhotoQuestion" class="clsaddquestion">Photo</a></span>
          </li>
          <li>
            <!-- <input type="radio" name="questionType" id="drodown" class="regular-radio">
            <label for="drodown" class=""></label> -->
            <span><a href="javascript:void(0)" id="DropDownQuestion" class="clsaddquestion">Dropdown</a></span>
          </li>
        </ul>
        <div class="clear"></div>
        <!-- <button class="addBtn Btn nrmlBtn">Add</button> -->
      </div>
      <a href="#" class="add-question-btn"></a>
      <span class="addQuestionText"> Click here to add question</span>
    </div>
  </form>
</div>


<script language="javascript">




  $(document).ready(function(){
  //   function set_order_number_for_question(QuestionCollection){
  //   if (_(QuestionCollection).isEmpty())
  //     return 0;
  //   else {
  //     var cu = 0;
  //     var it = _.max(QuestionCollection,function(max_item){ cu =(max_item.order_number =  max_item.order_number + ORDER_NUMBER_STEP)
  //     // console.log('1');
  //   }); 
  //   console.log('message');
  //    return cu;
  //   }
  // }

  function sub_ques_order_num(){

  }

  function main_ques_order_num(){
    if (MainQuestionCollection.length == 0 ){
      return 0;
    } else {
      // alert(MATH.max(MainQuestionCollection));
      max_item_item =  _.max(MainQuestionCollection, function(max_item) {
          
           return max_item.order_number;
         });
      // alert("MAX+ITEM" + max_item_item.order_number);
      return max_item_item.order_number + ORDER_NUMBER_STEP;
        // _.max(MainQuestionCollection, function(max_item){
        //   console.dir(max_item);
        //   return  (max_item.order_number + ORDER_NUMBER_STEP);
        // });
    }
  }

    var MainQuestionCollection = [];
    var SubQuestionCollection = [];

    $('#expiry_date').datepicker({ dateFormat: "yy-mm-dd" });

    $("#finalize").click(function(event) {
      finalize_survey();
    });
    
    finalize_survey = function() {
      if (confirm(I18n.t('surveys.confirm_finalize'))) {
    var survey_object = {
        description: $("#my_org_description").val(),
        expiry_date: $("#expiry_date").val(),
        name: $("#organization_name").val()
    };
    $.ajax({
        url: "/api/surveys/" + <%= @survey.id %> ,
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(survey_object),
        beforeSend: function(xhr) {
            xhr.setRequestHeader("X-Http-Method-Override", "PUT");
        },
        success: function(resultquery) {
            //console.log(resultquery);
        }
    });
    $.each(QuestionCollection, function(key, question) {
        // console.log("Curent Q type " + question.type);
        if (question.type == "MultiRecordCategory" || question.type == null) {
            $.ajax({
                url: "/api/categories/" + question.id,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(question),
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("X-Http-Method-Override", "PUT");
                },
                success: function(resultquery) {
                    console.log(resultquery);
                }
            });
        } else {
            console.log("saving " + question.type);
            $.ajax({
                url: "/api/questions/" + question.id,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(question),
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("X-Http-Method-Override", "PUT");
                },
                success: function(resultquery) {
                    console.log(resultquery);
                  
                }
            });

        }
        if (key == QuestionCollection.length-1) {
          // alert("HERE");
          $("#finalize_hidden").click();
        }   
        
    });
    } 

    }

    var old_text = 'Loading...';
    $(document).ajaxStart(function() {
      show_overlay(old_text);
    });
    
    $(document).ajaxStop(function() {
      hide_overlay();
    });
    

    
    function show_overlay(text){
      var opts;
        opts = {
          lines: 17,
          length: 9,
          width: 4,
          radius: 36,
          speed: 1.0,
          trail: 64,
          top: "5px",
          left: "25px",
          color: '#ddd'
        };

        $('#loading_overlay').css('display', 'block');
        $('#loading_overlay').children(".spinner").spin(opts);

        if (text) {
          old_text = $('#loading_overlay').children("p.text").text();
          $('#loading_overlay').children("p.text").text(text);
        }
    }

    function hide_overlay(){
     $('#loading_overlay').hide();
     if (old_text) {
        $('#loading_overlay').children("p.text").text(old_text);
      }   
    }





    //show rating questions 
    //  $('.ratingNo').live('change', function(event){
    //    $(event.target).closest('.star').raty({
    //   readOnly: true,
    //   number: $(event.target).val()
    // });
    // });

    //show rating questions 
    // $(document).find('.star').raty({
    //   readOnly: true,
    //   number: 5
    // });

    var QuestionCollectionToSave = [];
    
    function switch_case(type_id){
      switch (type_id){
        case 'SingleLineQuestion':
          return '#dummy_single_line_question_template'
          break;
        case 'MultilineQuestion':
          return '#dummy_multiline_question_template'
          break;
        case 'NumericQuestion':
          return '#dummy_numeric_question_template'
          break;
        case 'DateQuestion':
          return '#dummy_date_question_template'
          break;
        case 'RadioQuestion':
          return '#dummy_radio_question_template'
          break;
        case 'MultiChoiceQuestion':
          return '#dummy_multi_choice_question_template'
          break;
        case 'DropDownQuestion':
          return '#dummy_drop_down_question_template'
          break;
        case 'PhotoQuestion':
          return '#dummy_photo_question_template'
          break;
        case 'RatingQuestion':
          return '#dummy_rating_question_template'
          break;
        case 'MultiRecordCategory':
          return '#dummy_multi_record_category_template'
          break;
        case null:
          return '#dummy_category_template'
          break;
        default:
          return '#dummy_category_template'
      }
  }


    var level = 0;
    var sub_ques_num =0;
    var alphabet_level = 0;
    var QuestionKey_Val = new Array();
    var alphabets = ['A','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];

    var nesting_alphabet = 0;
    var nesting_level = 0;


    function generate_question_number(QuestionCollection){
      if (_(QuestionCollection).isEmpty())
        return 0;
      else {
          var cu = QuestionCollection.length;
         return cu;
        }
    }

    function serialize_questions(elements){
      $.each(elements, function(index, val) {
        var options = $(val).attr('options');
        if (typeof options !== typeof undefined && options !== false){

        }
      });
    }

    // var str = null;

    function recusrive_loop(options,level_ancestor){

      // alert("Here");
      var str_child = '';
      var alphabet_level_new = 0;
      $.each(options , function(key , item){
        OptionCollection.push(item);
        var template_option = $('#dummy_radio_option_template').html()
        var str_child3='';
        //alert(item.content);
        var cont = item.content;
        item.question_number = level_ancestor +  "." +  alphabets[++alphabet_level_new];
        str_child += Mustache.render(template_option, item);
        //alert("template_question");
        sub_ques_num = 0;
        var elements = $(item).attr('elements');
        if (typeof elements !== typeof undefined && elements !== false){

          $.each(elements , function(key , item_1){

            // alert("dsfasdf");
            QuestionCollection.push(item_1);
            var template_question = $(switch_case(item_1.type)).html()
            item_1.question_number = item.question_number + "." +  (++sub_ques_num); 
            str_child += Mustache.render(template_question, item_1);
            //alert(template_question);
            
            console.log("elements");
            console.log(item_1);
            //alert(cont + ':'+item_1.content);
             var options_1 = $(item_1).attr('options');

            if (typeof options_1 !== typeof undefined && options_1 !== false) {
              console.log("options_1");

              str_child += recusrive_loop(options_1,item_1.question_number);
              //str_child +='</surveyquestion>';
            }
            str_child += '</surveyquestion>';     
            //str_child3 += '</surveyquestionchild>';
          });
          // alert(str_child3);
          sub_ques_num = 0;
        }
        str_child += '</surveyquestionchild>';
        // alert("OUTSIDE : "+str_child); 
      });

      return str_child;
    }


    function recusrive_loop_multi(options,level_ancestor){
      //alert("Here");
      var str_child = '';
      var alphabet_level_new = 0;
      $.each(options , function(key , item){
        OptionCollection.push(item);
        var template_option = $('#dummy_multi_choice_option_template').html()
        var str_child3='';
        //alert(item.content);
        var cont = item.content;
        item.question_number = level_ancestor +  "." +  alphabets[++alphabet_level_new];
        str_child += Mustache.render(template_option, item);
        //alert("template_question");
        var elements = $(item).attr('elements');
        if (typeof elements !== typeof undefined && elements !== false){

          $.each(elements , function(key , item_1){

            // alert("dsfasdf");
            QuestionCollection.push(item_1);
            var template_question = $(switch_case(item_1.type)).html()
            item_1.question_number = item.question_number + "." +  (++sub_ques_num); 
            str_child += Mustache.render(template_question, item_1);
            //alert(template_question);
            
            console.log("elements");
            console.log(item_1);
            //alert(cont + ':'+item_1.content);
             var options_1 = $(item_1).attr('options');

            if (typeof options_1 !== typeof undefined && options_1 !== false) {
              console.log("options_1");

              str_child += recusrive_loop_multi(options_1,item_1.question_number);
              //str_child +='</surveyquestion>';
            }
            str_child += '</surveyquestion>';     
            //str_child3 += '</surveyquestionchild>';
          });
          // alert(str_child3);
          sub_ques_num = 0;
        }
        str_child += '</surveyquestionchild>';
        // alert("OUTSIDE : "+str_child); 
      });

      return str_child;
    }


    


    function recusrive_loop_drop(options,level_ancestor){

  //alert("Here");
      var str_child = '';
      var alphabet_level_new = 0;
      $.each(options , function(key , item){
         
        OptionCollection.push(item);
        var template_option = $('#dummy_drop_down_option_template').html();

        var str_child3='';
        //alert(item.content);
        var cont = item.content;
        item.question_number = level_ancestor +  "." +  alphabets[++alphabet_level_new];
        str_child += Mustache.render(template_option, item);
        //alert("template_question");
        var elements = $(item).attr('elements');
        if (typeof elements !== typeof undefined && elements !== false){

          $.each(elements , function(key , item_1){

            // alert("dsfasdf");
            QuestionCollection.push(item_1);
            var template_question = $(switch_case(item_1.type)).html()
            item_1.question_number = item.question_number + "." +  (++sub_ques_num); 
            str_child += Mustache.render(template_question, item_1);
            //alert(template_question);
            
            console.log("elements");
            console.log(item_1);
            //alert(cont + ':'+item_1.content);
             var options_1 = $(item_1).attr('options');

            if (typeof options_1 !== typeof undefined && options_1 !== false) {
              console.log("options_1");

              str_child += recusrive_loop_drop(options_1,item_1.question_number);
              //str_child +='</surveyquestion>';
            }
            str_child += '</surveyquestion>';     
            //str_child3 += '</surveyquestionchild>';
          });
          // alert(str_child3);
          sub_ques_num = 0;
        }
        str_child += '</surveyquestionchild>';
        // alert("OUTSIDE : "+str_child); 
      });
      return str_child;
    }

    function recusrive_loop_category(elements,level_ancestor){
      var str_child = '';
      var alphabet_level_new_cat = 0;
      $.each(elements , function(key , item){
        // alert(item);
        console.dir(item);

        var template_questions_1 = $(switch_case(item.type)).html();
        item.question_number = level_ancestor + "." + (++alphabet_level_new_cat) ;
        str_child += Mustache.render(template_questions_1, item);
        QuestionCollection.push(item);
        var options = $(item).attr('options');
        if (typeof options !== typeof undefined && options !== false){
          var alphabet_level_new_cat_opt = 0;
          $.each(options , function(key , item_1){
            // alert("I AM HERE");
            console.info("HERE" + item_1.type);
            console.dir(item_1);

            OptionCollection.push(item_1);
            var template_question = '';
            if (item_1.type == 'RadioQuestion') {
              template_question = $('#dummy_radio_option_template').html();
            } else if (item_1.type == 'MultiChoiceQuestion'){
              template_question = $('#dummy_multi_choice_option_template').html();
            } else if (item_1.type == 'DropDownQuestion'){
              template_question = $('#dummy_drop_down_option_template').html();
            }
            var template_question = $('#dummy_radio_option_template').html();
            // item_1.question_number = level_ancestor +  "." + alphabets[++alphabet_level_new] + (++sub_ques_num); 
            item_1.question_number = level_ancestor +  "." + alphabets[++alphabet_level_new_cat_opt]; 
            str_child += Mustache.render(template_question, item_1);
            // console.log("elements");
            console.log(item_1);
             var elements_1 = $(item_1).attr('elements');
            if (typeof elements_1 !== typeof undefined && elements_1 !== false) {
              console.log("elements_1");
              str_child += recusrive_loop_category(elements_1,item_1.question_number);
            }

          });
            sub_ques_num = 0;
            str_child += '</surveyquestionchild>';
          
        }

        str_child += '</surveyquestion>';
      });

      return str_child;
    }
    

    // allow_identifier = function() {
    //   return !(.parent_id) || _this.model.get('has_multi_record_ancestor'));
    // }
      function show_options(question){
        $.each(question.options , function(key , item){
          console.log(item);
        });
      }

      function show_options_questions(option){
       $.each(option.elements , function(key , item){
          return JSON.stringify(item);
        }); 
      }


    find_elements = function(elements , id ){
      var x = _.find(elements, function(obj){ return obj.id   == id; });
      // x = _.findWhere(elements, {id:758});
      // console.log( " HE GHE " );
      // console.dir (x);
    }


    preload_elements = function(elements) {
      console.dir(elements);
      
    return _(elements).each(function(resultquery) {
      console.dir(resultquery);
      resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
      resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
      resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
      
      console.log (resultquery.type)
      //alert(" TYPE " + resultquery.type);
      
      switch (resultquery.type){
        case 'SingleLineQuestion':
          var template = $('#dummy_single_line_question_template').html()
          resultquery.question_number = ++level;
          var str = Mustache.render(template, resultquery);


          $(".survey-builder").append(str);
          break;
        case 'MultilineQuestion':
          var template = $('#dummy_multiline_question_template').html()
          resultquery.question_number = ++level;
          var str = Mustache.render(template, resultquery);


          $(".survey-builder").append(str);
          break;
        case 'NumericQuestion':
          var template = $('#dummy_numeric_question_template').html()
          resultquery.question_number = ++level;
          var str = Mustache.render(template, resultquery);


          $(".survey-builder").append(str);
          break;
        case 'DateQuestion':
          var template = $('#dummy_date_question_template').html()
          resultquery.question_number = ++level;
          var str = Mustache.render(template, resultquery);


          $(".survey-builder").append(str);
          break;
        case 'RadioQuestion':
          sub_ques_num  = 0;
          var template = $('#dummy_radio_question_template').html()
          resultquery.question_number = ++level;
          var str = Mustache.render(template, resultquery);

          // alert(str);
          // alert("RADIO");


          // console.log("1" + str);

          var options = $(resultquery).attr('options');
          
          if (typeof options !== typeof undefined && options !== false) {
            console.log("options" + options);
            str += recusrive_loop(options,level); 
          } 
          str += "</surveyquestion>";
          $(".survey-builder").append(str);
          alphabet_level = 0;
          break;
        case 'MultiChoiceQuestion':
          // var template = $('#dummy_multi_choice_question_template').html()
          // resultquery.question_number = ++level;
          // var str = Mustache.render(template, resultquery);


          // $(".survey-builder").append(str);
          // alert("MultiChoiceQuestion");
          sub_ques_num  = 0;
          var template = $('#dummy_multi_choice_question_template').html()
          resultquery.question_number = ++level;
          var str = Mustache.render(template, resultquery);


          // console.log("1" + str);

          var options = $(resultquery).attr('options');
          
          if (typeof options !== typeof undefined && options !== false) {
            console.log("options");
            str += recusrive_loop_multi(options,level); 
          } 
          str += "</surveyquestion>";
          $(".survey-builder").append(str);
          alphabet_level = 0;
          break;
        case 'DropDownQuestion':
          // var template = $('#dummy_drop_down_question_template').html()
          // resultquery.question_number = ++level;
          // var str = Mustache.render(template, resultquery);
          // $(".survey-builder").append(str);
          // var template = $('#dummy_multi_choice_question_template').html()
          // resultquery.question_number = ++level;
          // var str = Mustache.render(template, resultquery);


          // $(".survey-builder").append(str);

          sub_ques_num  = 0;
          var template = $('#dummy_drop_down_question_template').html()
          resultquery.question_number = ++level;
          var str = Mustache.render(template, resultquery);


          // console.log("1" + str);

          var options = $(resultquery).attr('options');
          
          if (typeof options !== typeof undefined && options !== false) {
            console.log("options");
            str += recusrive_loop_drop(options,level); 
          } 
          str += "</surveyquestion>";
          $(".survey-builder").append(str);
          alphabet_level = 0;
          break;
        case 'PhotoQuestion':
          var template = $('#dummy_photo_question_template').html()
          resultquery.question_number = ++level;
          var str = Mustache.render(template, resultquery);


          $(".survey-builder").append(str);
          break;
        case 'RatingQuestion':
          var template = $('#dummy_rating_question_template').html()
          resultquery.question_number = ++level;
          var str = Mustache.render(template, resultquery);
          // alert(resultquery.max_length = 7 );

          $(".survey-builder").append(str);
            $(document).find('.star').raty({
              readOnly: true,
              number:  resultquery.max_length || 5 
            });
          break;
        case 'MultiRecordCategory':
          // var template = $('#dummy_multi_record_category_template').html()
          // resultquery.question_number = ++level;
          // var str = Mustache.render(template, resultquery);
          // $(".survey-builder").append(str);
          sub_ques_num  = 0;
          var template = $('#dummy_multi_record_category_template').html()
          resultquery.question_number = ++level;
          var str = Mustache.render(template, resultquery);


          // console.log("1" + str);

          var elements = $(resultquery).attr('elements');
          
          if (typeof elements !== typeof undefined && elements !== false) {
            console.log("elements CATEGORY");
            str += recusrive_loop_category(elements,level); 
          } 
          str += " </span></surveyquestion>";
          $(".survey-builder").append(str);
          alphabet_level = 0;
          break;
        case null:
        // alert("CATEGORY");
          // var template = $('#dummy_category_template').html()
          // resultquery.question_number = ++level;
          // var str = Mustache.render(template, resultquery);
          // $(".survey-builder").append(str);
          sub_ques_num  = 0;
          var template = $('#dummy_category_template').html();
          resultquery.question_number = ++level;
          var str = Mustache.render(template, resultquery);
          var elements = $(resultquery).attr('elements');
          if (typeof elements !== typeof undefined && elements !== false) {
            console.log("elements CATEGORY");
            str += recusrive_loop_category(elements,level); 
          } 
          str += "</surveyquestion>";
          $(".survey-builder").append(str);
          alphabet_level = 0;
          break;
        default:
          var template = $('#dummy_category_template').html()
          resultquery.question_number = ++level;
          var str = Mustache.render(template, resultquery);


          $(".survey-builder").append(str);
      }

      QuestionCollection.push(resultquery);
      console.log(QuestionCollection);

    });
};
            $.get("/api/surveys/"+<%= @survey.id %>, function(resultquery) {
             // console.log(resultquery.elements);

              preload_elements(resultquery.elements);
              find_elements(resultquery.elements);
              serialize_questions(resultquery.elements);
              QuestionCollectionToSave = QuestionCollection;
              // QuestionCollection.push(resultquery);
            console.log(QuestionCollection);
            var MainQuestion  = 0;
            var SubQuestion  = 0;
            // alert(QuestionCollection.length);
            $.each(QuestionCollection, function(index, val) {
              console.log(val.content);
              console.log ("val.parent_id" + val.category_id);
                 if (val.category_id == null || val.parent_id != null){
                  MainQuestionCollection.push(val);
                    MainQuestion++;
                 } else if (val.category_id != null){
                    SubQuestion++;
                 }
            });

            // alert("MainQuestion :" + MainQuestion + ", SubQuestion :" + SubQuestion);
              $('.clsass_main_questions').text(MainQuestion);
              $('.clsass_sub_questions').text(SubQuestion);
            }); 

           // $(document).find('.star').raty({
           //    readOnly: true,
           //    number: 5
           //  });


             // $.get("/api/categories/"+<%= @survey.id %>, function(resultquery) {
             //    console.dir(resultquery);
             // });



   
   var ORDER_NUMBER_STEP = 2;
   var ORDER_NUMBER_STEP_OPTIONS = 1;
   var seed_option_number = 0;
   var QuestionCollection = [];
   var OptionCollection = [];
 $(".clsaddquestion").click(function() {
  var curr = $('#current_order_num').val();
  // var order_number_send = set_order_number_for_question(QuestionCollection);
 var query = {
     question: {
         content: 'Untitled Question',
         survey_id: <%= @survey.id %> ,
         mandatory: false,
         type: $(this).attr('id'),
         order_number : main_ques_order_num(),
         identifier: false
     }
 };
 resultquery = null;
  // alert("CURRENT SENT ORDER NUMBER " + query.question.order_number);

 // function set_order_number_for_option(OptionCollection){
 //  if (_(OptionCollection).isEmpty())
 //    return 0;
 //  else {
 //     var cu = 0;
 //    var it = _.max(OptionCollection,function(max_item){ cu =(max_item.order_number =  max_item.order_number + ORDER_NUMBER_STEP_OPTIONS)
 //    }); 
 //    // console.log('message');
 //    console.log('ORDER NUMBER_OPTION => ' + cu);
 //     return cu;
 //    }
 //  }


 // function set_order_number_for_question(QuestionCollection){
 //  console.log(QuestionCollection);
 //  if (_(QuestionCollection).isEmpty())
 //    return 0;
 //  else {
 //     var cu = 0;

 //    var it = _.max(QuestionCollection,function(max_item){ cu =(max_item.order_number =  max_item.order_number + ORDER_NUMBER_STEP);
 //    }); 
 //    // console.log('message');
 //    console.log('ORDER NUMBER => ' + cu);
 //     return cu;
 //    }
 //  }
  var multi_cat_type = $(this).attr('id');
 switch ($(this).attr('id')) {
     case 'SingleLineQuestion':
        query.question.content = "SingleLine Question";
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             
             var template = $('#dummy_single_line_question_template').html();
             console.dir(QuestionCollection);
             var str = Mustache.render(template, resultquery);
             console.log(resultquery);
             $(".survey-builder").append(str);
             reset_builder();
         });

         break;
     case 'MultilineQuestion':
        query.question.content = "MultiLine Question";
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_multiline_question_template').html();
             var str = Mustache.render(template, resultquery);
             $(".survey-builder").append(str);
             reset_builder();
         });

         break;
     case 'NumericQuestion':
     query.question.content = "Numeric Question";
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_numeric_question_template').html();
             var str = Mustache.render(template, resultquery);
             $(".survey-builder").append(str);
             reset_builder();
         });

         break;
     case 'DateQuestion':
     query.question.content = "Date Question";
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_date_question_template').html();
             var str = Mustache.render(template, resultquery);
             $(".survey-builder").append(str);
             reset_builder();
         });

         break;
     case 'RadioQuestion':
     query.question.content = "Radio Question";
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_radio_question_template').html();
             var str = Mustache.render(template, resultquery);
             $(".survey-builder").append(str);
             reset_builder();
         });

         break;
     case 'MultiChoiceQuestion':
     query.question.content = "Multi Choice Question";
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_multi_choice_question_template').html();
             var str = Mustache.render(template, resultquery);
             $(".survey-builder").append(str);
             reset_builder();
         });

         break;
     case 'DropDownQuestion':
     query.question.content = "Drop Down Question";
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_drop_down_question_template').html();
             var str = Mustache.render(template, resultquery);
             $(".survey-builder").append(str);
             reset_builder();
         });

         break;
     case 'PhotoQuestion':
     query.question.content = "Photo Question";
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_photo_question_template').html();
             var str = Mustache.render(template, resultquery);
             $(".survey-builder").append(str);
             reset_builder();
         });

         break;
     case 'RatingQuestion':
     query.question.content = "Rating Question";
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_rating_question_template').html();
             console.log(template);
             var str = Mustache.render(template, resultquery);
             $(".survey-builder").append(str);
             reset_builder();
         });

         break;
     case 'MultiRecordCategory':
        multi = {
           category: {
               content: 'Untitled Multi Record',
               survey_id: <%= @survey.id %> ,
               type:multi_cat_type,
               order_number : main_ques_order_num()

           }
         };
          
          $.post("/api/categories/", multi, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/categories/" + resultquery.id + '/duplicate';
             // resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             
             var template = $('#dummy_multi_record_category_template').html();
             var str = Mustache.render(template, resultquery);
             $(".survey-builder").append(str);
         });

         break;
       case 'CategoryQuestion':
         var query = {
             category: {
                 content: 'Untitled Category',
                 survey_id: <%= @survey.id %> ,
                 order_number : main_ques_order_num()
             }
         }; 
         $.post("/api/categories/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/categories/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/categories/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             // console.dir(QuestionCollection);
             var template = $('#dummy_category_template').html();
             var str = Mustache.render(template, resultquery);
             $(".survey-builder").append(str);
         });

         break;
     default:
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_category_template').html();
             var str = Mustache.render(template, resultquery);
             $(".survey-builder").append(str);
             reset_builder();
         });
  }
 });


function reset_builder(){
      var survey_object = {
        description: $("#my_org_description").val(),
        expiry_date: $(".expiry_date").val(),
        name: $("#organization_name").val()
        /*organization_logo_url: "https://surveywebproductionassets.s3.amazonaws.com/uploads/user_service/organization/ logo/23/thumb_userworks_logo.png"*/
      };

      $.ajax({
            url: "/api/surveys/" + <%= @survey.id %>,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(survey_object),
              beforeSend: function(xhr)   
                {
                  xhr.setRequestHeader("X-Http-Method-Override", "PUT");
                },
                success:function(resultquery){
                  //console.log(resultquery);
                }
          });

        // console.log(QuestionCollectionToSave );
        $.each(QuestionCollection,function(key,question){
        console.log("Curent Q type " + question.type);
        if (question.type == "MultiRecordCategory" || question.type == null) {
          $.ajax({
            url: "/api/categories/" + question.id,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(question),
              beforeSend: function(xhr)   
                {
                  xhr.setRequestHeader("X-Http-Method-Override", "PUT");
                },
                success:function(resultquery){
                  //console.log(resultquery);
                }
            });  
        } else {
          console.log (" SEnding " +question.order_number);
          console.log("saving " + question.type);
          $.ajax({
            url: "/api/questions/" + question.id,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(question),
              beforeSend: function(xhr)   
                {
                  xhr.setRequestHeader("X-Http-Method-Override", "PUT");
                },
                success:function(resultquery){
                }
          });
      } 

});
      
    $.each(OptionCollection,function(key,option){

        $.ajax({
            url: "/api/options/" + option.id,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(option),
              beforeSend: function(xhr)   
                {
                  xhr.setRequestHeader("X-Http-Method-Override", "PUT");
                },
                success:function(resultquery){
                  //console.log(resultquery);
                }
          });

    });

  //// 


  $.get("/api/surveys/"+<%= @survey.id %>, function(resultquery) {
      // console.log(resultquery.elements);
    $(".survey-builder").html("");
    level = 0;
    sub_ques_num =0;
    alphabet_level = 0;
    QuestionKey_Val = new Array();
    alphabets = ['A','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];

      nesting_alphabet = 0;
      nesting_level = 0;
      ORDER_NUMBER_STEP = 2;
      ORDER_NUMBER_STEP_OPTIONS = 1;
      seed_option_number = 0;
      QuestionCollection = [];
      OptionCollection = [];
      query = null;
      multi = null;
      preload_elements(resultquery.elements);
      var MainQuestion  = 0;
      var SubQuestion  = 0;
      // alert(QuestionCollection.length);
      $.each(QuestionCollection, function(index, val) {
        console.log ("val.parent_id" + val.category_id);
        if (val.category_id == null && val.parent_id != null ){
          MainQuestion++;
          MainQuestionCollection.push(val);
        } else if (val.category_id != null){
          SubQuestion++;
        }
      });
      // alert("MainQuestion :" + MainQuestion + ", SubQuestion :" + SubQuestion);
      $('.clsass_main_questions').text(MainQuestion);
      $('.clsass_sub_questions').text(SubQuestion);
  });
        try{
               $(".survey-builder" ).sortable('destroy');
               $("surveyquestionchild" ).sortable('destroy');
              setTimeout(reinitialize_sort, 3000);
        }catch(error){
        console.log('done'+error);
        }
        }

// reset builder end

//My task
$("input[type=checkbox]").live('change',function(){
  var qustion_id = $(this).closest('surveyquestion').attr('id');
var flag = $(this).is(':checked');
var attribute = $(this).attr('name');
$.each(QuestionCollection,function(key,val){
 if(qustion_id == val.id){
  if(attribute == 'mandatory'){
QuestionCollection[key].mandatory = flag;
  }else if(attribute == 'identifier'){
QuestionCollection[key].identifier = flag;
  }else if(attribute == 'private'){
QuestionCollection[key].private = flag;
  }
  }
});
});

$("input[type=text],input[type=number]").live('keyup',function(event){
  var qustion_id = $(this).closest('surveyquestion').attr('id');
  var val_text = $(this).val();
  var attribute = $(this).attr('name');
  if($(this).hasClass( "option" )){
    var option_id = $(this).attr('data-id');
  $.each(OptionCollection,function(key,val){
   if(option_id == val.id){
      OptionCollection[key].content = val_text;
    }
  });
  }else{
  $.each(QuestionCollection,function(key,val){

   if(qustion_id == val.id){
    if(attribute == 'content'){
  QuestionCollection[key].content = val_text;
  console.dir(QuestionCollection[key].content);
    }else if(attribute == 'max_length'){
  QuestionCollection[key].max_length = parseInt(val_text);
  // console.log(QuestionCollection[key].max_length);
    }else if(attribute == 'max_value'){
  QuestionCollection[key].max_value = parseInt(val_text);
    }else if(attribute == 'min_value'){
  QuestionCollection[key].min_value = parseInt(val_text);
    }
    }
  });
  }
});


$("input[type=text],input[type=number]").live('change',function(event){
var qustion_id = $(this).closest('surveyquestion').attr('id');
var val_text = $(this).val();
var attribute = $(this).attr('name');
if($(this).hasClass( "option" )){
  var option_id = $(this).attr('data-id');
$.each(OptionCollection,function(key,val){
 if(option_id == val.id){
    OptionCollection[key].content = val_text;
  }
});
}else{
$.each(QuestionCollection,function(key,val){

 if(qustion_id == val.id){
  if(attribute == 'content'){
QuestionCollection[key].content = val_text;
console.dir(QuestionCollection[key].content);
  }else if(attribute == 'max_length'){
QuestionCollection[key].max_length = val_text;
  }else if(attribute == 'max_value'){
QuestionCollection[key].max_value = val_text;
  }else if(attribute == 'min_value'){
QuestionCollection[key].min_value = val_text;
  }
  }
});
}
});

$("input[type=file]").live('click',function(){
  var qustion_id = $(this).closest('surveyquestion').attr('id');
  var attribute = $(this).attr('name');
//  alert(qustion_id);
   // alert("HELLO");
  var img_ck = this;
  var parent_div = $(this).closest('surveyquestion');
  var img_path = '';
    $(this).fileupload({
   dataType: "json",
   url: "/api/questions/"+qustion_id+"/image_upload",
   submit: function() {
     // return loading_overlay.show_overlay(I18n.t("js.uploading_image"));
     //alert('done');
   },
   done: function(e, data) {
     //alert('done');

     img_path = data.result.image_url;
      $.each(QuestionCollection,function(key,val){
      if(qustion_id == val.id){
      if(attribute == 'image'){
      QuestionCollection[key].image_upload_url = img_path;
      $(parent_div).find('img.thumb').attr('src',img_path);
      }
      }
      });
   }
  });
});

// $("input[type=file]").live('click',function(event){
//   //alert("HELLO" + $(event.target).val());
//   //$(this).val(null);
//   $(this).value = null;
// });

/*
$("input[type=file]").live('click',function(event){
  // alert("HELLO");
  $(event.target).value = null;
});


$("input[type=file]").live('change',function(){
  var qustion_id = $(this).closest('surveyquestion').attr('id');
  var attribute = $(this).attr('name');
//  alert(qustion_id);
  // alert("HELLO");
  var img_ck = this;
  var parent_div = $(this).closest('surveyquestion');
  var img_path = '';
    $(img_ck).fileupload({
   dataType: "json",
   url: "/api/questions/"+qustion_id+"/image_upload",
   submit: function() {
     // return loading_overlay.show_overlay(I18n.t("js.uploading_image"));
     //alert('done');
   },
   done: function(e, data) {
     //alert('done');

     img_path = data.result.image_url;
      $.each(QuestionCollection,function(key,val){
      if(qustion_id == val.id){
      if(attribute == 'image'){
      QuestionCollection[key].image_upload_url = img_path;
      $(parent_div).find('img.thumb').attr('src',img_path);
      }
      }
      });
   }
  });
});
*/
//my task
//
// Delete question 
$(".delete_question").live('click',function(event){
        // question_to_delete = $(event.target).closest('surveyquestion');
         $(event.target).closest('surveyquestion').remove();
        question_id = $(event.target).closest('surveyquestion').attr('id');
        var current_qu_to_delete;
        $.each(QuestionCollection, function(index, val) {
           if ( val.id == question_id){
              current_qu_to_delete = val;
              QuestionCollection.splice(index,1);
              return  false;
           }
        });
        
        if ( current_qu_to_delete.type == "MultiRecordCategory" || current_qu_to_delete.type == null){
          $.ajax({
            url: "/api/categories/" + question_id,
            type: "POST",
            contentType: "application/json",
              beforeSend: function(xhr)   
                {
                  xhr.setRequestHeader("X-Http-Method-Override", "DELETE");
                },
                success:function(resultquery){
                  console.log(resultquery);
                 
                }
          });
        } else {
          $.ajax({
            url: "/api/questions/" + question_id,
            type: "POST",
            contentType: "application/json",
              beforeSend: function(xhr)   
                {
                  xhr.setRequestHeader("X-Http-Method-Override", "DELETE");
                },
                success:function(resultquery){
                  console.log(resultquery);
                 
                }
          });  
        }

        
        reset_builder();

});
// Delete question



// Delete option
$(".delete_option").live('click', function(event) {
  $(this).closest('surveyquestionchild').remove();
   option_id = $(event.target).closest('surveyquestionchild').attr('id');
        $.each(OptionCollection, function(index, val) {
           if ( val.id == option_id){
              OptionCollection.splice(index,1);
              return  false;
           }
        });
      $.ajax({
            url: "/api/options/" + option_id,
            type: "POST",
            contentType: "application/json",
              beforeSend: function(xhr)   
                {
                  xhr.setRequestHeader("X-Http-Method-Override", "DELETE");
                },
                success:function(resultquery){
                  console.log(resultquery);
                 
                }
          });
       reset_builder(); 
});
// Delee option end

/// Add multi record sub question 

$("a.add_sub_question_in_cat_multi").live('click',function(event){
  //alert("HELLO  " + $(this).closest('surveyquestion').attr("id"));
  var sub_q_type = $(this).siblings('#questions').val();
  // return false;
  var subquestion_this = $(this);
  // var curr = $('#current_order_num').val();
  // var order_number_send = set_order_number_for_question(QuestionCollection);
  var query = {
     question: {
         content: 'Untitled Question',
         survey_id: <%= @survey.id %> ,
         type: sub_q_type,
         order_number : set_order_number_for_question(QuestionCollection),
         category_id: $(this).closest('surveyquestion').attr("id"),
         identifier: false
     }
  };
  resultquery = null;
  // function set_order_number_for_question(QuestionCollection){
  //   if (_(QuestionCollection).isEmpty())
  //     return 0;
  //   else {
  //     var cu = 0;
  //     var it = _.max(QuestionCollection,function(max_item){ cu =(max_item.order_number =  max_item.order_number + ORDER_NUMBER_STEP)
  //     // console.log('1');
  //   }); 
  //   console.log('message');
  //    return cu;
  //   }
  // }

 switch (sub_q_type) {
     case 'SingleLineQuestion':
         query.question.content = "SingleLineQuestion";
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             
             var template = $('#dummy_single_line_question_template').html();
             var str = Mustache.render(template, resultquery);
             console.log(resultquery);
             subquestion_this.closest('surveyquestion').append(str);
         });

         break;
     case 'MultilineQuestion':
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_multiline_question_template').html();
             var str = Mustache.render(template, resultquery);
             subquestion_this.closest('surveyquestion').append(str);
         });

         break;
     case 'NumericQuestion':
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_numeric_question_template').html();
             var str = Mustache.render(template, resultquery);
             subquestion_this.closest('surveyquestion').append(str);
         });

         break;
     case 'DateQuestion':
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_date_question_template').html();
             var str = Mustache.render(template, resultquery);
             subquestion_this.closest('surveyquestion').append(str);
         });

         break;
     case 'RadioQuestion':
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_radio_question_template').html();
             var str = Mustache.render(template, resultquery);
             subquestion_this.closest('surveyquestion').append(str);
         });

         break;
     case 'MultiChoiceQuestion':
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_multi_choice_question_template').html();
             var str = Mustache.render(template, resultquery);
             subquestion_this.closest('surveyquestion').append(str);
         });

         break;
     case 'DropDownQuestion':
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_drop_down_question_template').html();
             var str = Mustache.render(template, resultquery);
             subquestion_this.closest('surveyquestion').append(str);
         });

         break;
     case 'PhotoQuestion':
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_photo_question_template').html();
             var str = Mustache.render(template, resultquery);
             subquestion_this.closest('surveyquestion').append(str);
         });

         break;
     case 'RatingQuestion':
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_rating_question_template').html();
             var str = Mustache.render(template, resultquery);
             subquestion_this.closest('surveyquestion').append(str);
         });

         break;
       case 'CategoryQuestion':
         query = {
           category: {
               content: 'Untitled Category',
               survey_id: <%= @survey.id %> ,
               order_number : order_number_send
           }
         };
         $.post("/api/categories/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/categories/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/categories/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             console.dir(QuestionCollection);
             var template = $('#dummy_category_template').html();
             var str = Mustache.render(template, resultquery);
             subquestion_this.closest('surveyquestion').append(str);
         });

         break;
     default:
         $.post("/api/questions/", query, function(resultquery) {
             resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
             resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
             resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
             QuestionCollection.push(resultquery);
             var template = $('#dummy_category_template').html();
             var str = Mustache.render(template, resultquery);
             subquestion_this.closest('surveyquestion').append(str);
         });
  }

 });
////  Add multi record sub question  END




// Add Option


$("a.add_options_in_bulk").live('click',function(event){
        // i = 1070;
        current_question  = 0;
        question_id = $(event.target).closest('surveyquestion').attr('id');
        $.each(QuestionCollection, function(index, val) {
          if ( val.id == question_id){
            current_question = val;
            options = $(val).attr('options');  
            $.each(options, function(index, val_opt) {
               $.ajax({
                    async: false,
                    url: "/api/options/" + val_opt.id,
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(val_opt),
                      beforeSend: function(xhr)   
                        {
                          //alert("ID" + val_opt.id);
                          xhr.setRequestHeader("X-Http-Method-Override", "DELETE");
                          $("#"+ val_opt.id).remove();
                        },
                        success:function(resultquery){
                          //console.log(resultquery);
                        }
                  });
            });
            console.dir(options);
          }
        });
        csv = $(this).closest('surveyquestion').find('textarea.add_options_in_bulk').val();
        console.log(csv);
        if (csv === "") {
            return 
        } else {
          try {
              parsed_csv = $.csv.toArray(csv);
              console.dir(parsed_csv);
                $.each(parsed_csv, function(item,val){
                    var query = {
                    option : {
                      content:val, 
                      order_number:item, 
                      question_id:question_id
                    }
                };
                $.post("/api/options/", query, function(resultquery) {
                    OptionCollection.push(resultquery);
                    console.log (resultquery);
                    current_question.options.push(resultquery);
                    var template = $('#dummy_radio_option_template').html(); 
                    var str = Mustache.render(template, resultquery);
                    $('#' + question_id).closest('surveyquestion').append(str);
                });
              });
              // return parsed_csv;
            } catch (error) {
              alert(I18n.t("js.require_csv_format"));
            }
            reset_builder();
        }
});

//Add Option End

// Add option for sapad re
$("a.add_options_in_bulk_multi_choice").live('click',function(event){
        question_id = $(event.target).closest('surveyquestion').attr('id');
        //alert(question_id);
        $.each(QuestionCollection, function(index, val) {
          if ( val.id == question_id){
            options = $(val).attr('options');  
            $.each(options, function(index, val_opt) {
               $.ajax({
                    async: false,
                    url: "/api/options/" + val_opt.id,
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(val_opt),
                      beforeSend: function(xhr)   
                        {
                          xhr.setRequestHeader("X-Http-Method-Override", "DELETE");
                        },
                        success:function(resultquery){
                          //console.log(resultquery);
                        }
                  });
            });
            console.dir(options);
          }
        });
        csv = $(this).closest('surveyquestion').find('textarea.add_options_in_bulk').val();
        console.log(csv);
        if (csv === "") {
            return 
        } else {
          try {
              parsed_csv = $.csv.toArray(csv);
              console.dir(parsed_csv);
                $.each(parsed_csv, function(item,val){
                    var query = {
                    option : {
                      content:val, 
                      order_number:item, 
                      question_id:question_id
                    }
                };
                $.post("/api/options/", query, function(resultquery) {
                    OptionCollection.push(resultquery);
                    console.log (resultquery);
                    var template = $('#dummy_multi_choice_option_template').html(); 
                    var str = Mustache.render(template, resultquery);
                    $('#' + question_id).closest('surveyquestion').append(str);
                });
              });
              // return parsed_csv;
            } catch (error) {
              alert(I18n.t("js.require_csv_format"));
            }
            reset_builder();
        }
});
// Add option for multichoice END


/// 
$("a.add_options_in_bulk_drop_down").live('click',function(event){
      //alert("AAHE MI PAN");
        // i = 1000;
        question_id = $(event.target).closest('surveyquestion').attr('id');
        $.each(QuestionCollection, function(index, val) {
          if ( val.id == question_id){
            options = $(val).attr('options');  
            $.each(options, function(index, val_opt) {
               $.ajax({
                    async: false,
                    url: "/api/options/" + val_opt.id,
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(val_opt),
                      beforeSend: function(xhr)   
                        {
                          xhr.setRequestHeader("X-Http-Method-Override", "DELETE");
                        },
                        success:function(resultquery){
                          //console.log(resultquery);
                        }
                  });
            });
            console.dir(options);
          }
        });
        csv = $(this).closest('surveyquestion').find('textarea.add_options_in_bulk').val();
        console.log(csv);
        if (csv === "") {
            return 
        } else {
          try {
              parsed_csv = $.csv.toArray(csv);
              console.dir(parsed_csv);
              // seed_option_number =0;
                $.each(parsed_csv, function(item,val){
                    var query = {
                    option : {
                      content:val, 
                      order_number:item, 
                      question_id:question_id
                    }
                };
                $.post("/api/options/", query, function(resultquery) {
                    OptionCollection.push(resultquery);
                    console.log (resultquery);
                    var template = $('#dummy_drop_down_option_template').html(); 
                    var str = Mustache.render(template, resultquery);
                    $('#' + question_id).closest('surveyquestion').append(str);
                });
              });
              // return parsed_csv;
            } catch (error) {
              alert(I18n.t("js.require_csv_format"));
            }
            reset_builder();
        }
});

/// 
/// 
$("a.add_sub_question_category").live('click',function(event){
      //alert("MI PAN AAHE  RE");
        i = 1100;
        question_id = $(event.target).closest('surveyquestion').attr('id');
        csv = $(this).closest('surveyquestion').find('textarea.add_options_in_bulk').val();
        console.log(csv);
        if (csv === "") {
            return 
        } else {
          try {
              parsed_csv = $.csv.toArray(csv);
              console.dir(parsed_csv);
                $.each(parsed_csv, function(item,val){
                    var query = {
                    option : {
                      content:val, 
                      order_number:null, 
                      question_id:question_id
                    }
                };
                $.post("/api/questions/", query, function(resultquery) {
                    OptionCollection.push(resultquery);
                    console.log (resultquery);
                    var template = $('#dummy_drop_down_option_template').html(); 
                    var str = Mustache.render(template, resultquery);
                    $('#' + question_id).closest('surveyquestion').append(str);
                });
              });
              // return parsed_csv;
            } catch (error) {
              alert(I18n.t("js.require_csv_format"));
            }
            reset_builder();
        }
});

/// 

//
//
// ADD sub question 

$("a.add_sub_question").live('click',function(event){
$(this).prev(".question-types").toggleClass('show');
// var sub_q_type = $(this).siblings('#questions').val();
});

$(".clsaddquestion_sub").live("click", function(event) {
    sub_q_type = $(event.target).attr('id');
    temp_id = $(event.target).closest('surveyquestionchild').attr('id');
    question_id_nearest = $(event.target).closest('surveyquestion').attr('id');
    current_parent_question = null;
    curren_order_num_to_sub_question = 0;
    $.each(QuestionCollection, function(index, val) {
      // alert("COUNT" + index);
       if (val.id == question_id_nearest ){

        current_parent_question = val;
        options  = $(current_parent_question).attr('options');
        $.each(options, function(index, val_1) {
           if (val_1.id == temp_id ){

              if (_.isEmpty(val_1.elements)){
                curren_order_num_to_sub_question = 0;
              } else {
                _.max(val_1.elements,function(max_element){
                 
                  curren_order_num_to_sub_question = (max_element.order_number);
                   // alert(" max_element ORDER NUM " + curren_order_num_to_sub_question);
                });
                  curren_order_num_to_sub_question += ORDER_NUMBER_STEP;
              }
            }
        });
        return false;
       }
    });

    // alert( "curren_order_num_to_sub_question" + curren_order_num_to_sub_question);

    console.log(temp_id);
    // alert("HELO");
    var subquestion_this = $(this);
    // var order_number_send = set_order_number_for_question(QuestionCollection);
    var query = {
        question: {
            content: 'Untitled Question',
            survey_id: <%= @survey.id %> ,
            type: sub_q_type,
            order_number: curren_order_num_to_sub_question,
            parent_id: $(this).closest('surveyquestionchild').attr("id"),
            identifier: false
        }
    };
    resultquery = null;

    // function set_order_number_for_question(QuestionCollection) {
    //     if (_(QuestionCollection).isEmpty())
    //         return 0;
    //     else {
    //         var cu = 0;
    //         var it = _.max(QuestionCollection, function(max_item) {
    //             cu = (max_item.order_number = max_item.order_number + ORDER_NUMBER_STEP)
    //         });
    //         console.log('message');
    //         return cu;
    //     }
    // }

    switch (sub_q_type) {
        case 'SingleLineQuestion':
            query.question.content = "SingleLineQuestion";
            $.post("/api/questions/", query, function(resultquery) {
                resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                QuestionCollection.push(resultquery);
                var template = $('#dummy_single_line_question_template').html();
                var str = Mustache.render(template, resultquery);
                console.log(resultquery);
                subquestion_this.closest('surveyquestionchild').append(str);
                reset_builder();
            });
            break;
        case 'MultilineQuestion':
            $.post("/api/questions/", query, function(resultquery) {
                resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                QuestionCollection.push(resultquery);
                var template = $('#dummy_multiline_question_template').html();
                var str = Mustache.render(template, resultquery);
                subquestion_this.closest('surveyquestionchild').append(str);
                reset_builder();
            });
            break;
        case 'NumericQuestion':
            $.post("/api/questions/", query, function(resultquery) {
                resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                QuestionCollection.push(resultquery);
                var template = $('#dummy_numeric_question_template').html();
                var str = Mustache.render(template, resultquery);
                subquestion_this.closest('surveyquestionchild').append(str);
                reset_builder();
            });

            break;
        case 'DateQuestion':
            $.post("/api/questions/", query, function(resultquery) {
                resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                QuestionCollection.push(resultquery);
                var template = $('#dummy_date_question_template').html();
                var str = Mustache.render(template, resultquery);
                subquestion_this.closest('surveyquestionchild').append(str);
                reset_builder();
            });

            break;
        case 'RadioQuestion':
            $.post("/api/questions/", query, function(resultquery) {
                resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                QuestionCollection.push(resultquery);


                var template = $('#dummy_radio_question_template').html();
                var str = Mustache.render(template, resultquery);
                subquestion_this.closest('surveyquestionchild').append(str);
                reset_builder();

            });

            break;
        case 'MultiChoiceQuestion':
            $.post("/api/questions/", query, function(resultquery) {
                resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                QuestionCollection.push(resultquery);


                var template = $('#dummy_multi_choice_question_template').html();
                var str = Mustache.render(template, resultquery);
                subquestion_this.closest('surveyquestionchild').append(str);
                reset_builder();

            });

            break;
        case 'DropDownQuestion':
            $.post("/api/questions/", query, function(resultquery) {
                resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                QuestionCollection.push(resultquery);


                var template = $('#dummy_drop_down_question_template').html();
                var str = Mustache.render(template, resultquery);
                subquestion_this.closest('surveyquestionchild').append(str);
                reset_builder();

            });

            break;
        case 'PhotoQuestion':
            $.post("/api/questions/", query, function(resultquery) {
                resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                QuestionCollection.push(resultquery);


                var template = $('#dummy_photo_question_template').html();
                var str = Mustache.render(template, resultquery);
                subquestion_this.closest('surveyquestionchild').append(str);
                reset_builder();

            });

            break;
        case 'RatingQuestion':
            $.post("/api/questions/", query, function(resultquery) {
                resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                QuestionCollection.push(resultquery);


                var template = $('#dummy_rating_question_template').html();
                var str = Mustache.render(template, resultquery);
                subquestion_this.closest('surveyquestionchild').append(str);
                reset_builder();

            });

            break;
        case 'MultiRecordCategory':

            multi = {
                category: {
                    content: 'Untitled Category',
                    survey_id: <%= @survey.id %> ,
                    order_number: order_number_send,
                    type: "MultiRecordCategory",
                    parent_id: $(this).closest('surveyquestionchild').attr("id")

                }
            };
            $.post("/api/categories/", multi, function(resultquery) {
                resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                resultquery.duplicate_url = "/api/categories/" + resultquery.id + '/duplicate';

                QuestionCollection.push(resultquery);


                var template = $('#dummy_multi_record_category_template').html();
                var str = Mustache.render(template, resultquery);
                subquestion_this.closest('surveyquestionchild').append(str);


            });

            break;
        case 'CategoryQuestion':

            query = {
                category: {
                    content: 'Untitled Category',
                    survey_id: <%= @survey.id %> ,
                    order_number: order_number_send,
                    parent_id: $(this).closest('surveyquestionchild').attr("id")
                }
            };
            $.post("/api/categories/", query, function(resultquery) {
                resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                resultquery.duplicate_url = "/api/categories/" + resultquery.id + '/duplicate';
                resultquery.image_upload_url = "/api/categories/" + resultquery.id + '/image_upload';
                QuestionCollection.push(resultquery);
                console.dir(QuestionCollection);


                var template = $('#dummy_category_template').html();
                var str = Mustache.render(template, resultquery);
                subquestion_this.closest('surveyquestionchild').append(str);


            });

            break;
        default:
            $.post("/api/questions/", query, function(resultquery) {
                resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                QuestionCollection.push(resultquery);


                var template = $('#dummy_category_template').html();
                var str = Mustache.render(template, resultquery);
                subquestion_this.closest('surveyquestionchild').append(str);
                reset_builder();

            });
    }
});

$("a.add_sub_question_2").live('click',function(event){
  $(this).prev(".question-types").toggleClass('show');
});


// COME BACK HERE

 $(".clsaddquestion_sub_2").live("click", function(event) {
     sub_q_type = $(event.target).attr('id');
     //////////////////////////////////////////////////
    // temp_id = $(event.target).closest('surveyquestionchild').attr('id');
    question_id_nearest = $(event.target).closest('surveyquestion').attr('id');
    current_question_cat = null;
    curren_order_num_to_sub_question = 0;
    console.dir(QuestionCollection);
    
    $.each(QuestionCollection, function(index, val) {
      // alert("val.id " + val.id + " question_id_nearest" + question_id_nearest);
       if (val.id == question_id_nearest ){
        // alert("Found");
        current_question_cat = val;
        elements_1  = $(current_question_cat).attr('elements');
          if (elements_1){
            if (_.isEmpty(elements_1)){
                curren_order_num_to_sub_question = 0;
              } else {
                _.max(elements_1,function(max_element){
                 
                  curren_order_num_to_sub_question = (max_element.order_number);
                   // alert(" max_element ORDER NUM " + curren_order_num_to_sub_question);
                });
                  curren_order_num_to_sub_question += ORDER_NUMBER_STEP;
              }
          }
          return false;
       }
    });
     //////////////////////////////////////////////////

     var subquestion_this = $(this);
     console.log(this);
     // var order_number_send = set_order_number_for_question(QuestionCollection);
     var query = {
         question: {
             content: 'Untitled Question',
             survey_id: <%= @survey.id %> ,
             type: sub_q_type,
             order_number: curren_order_num_to_sub_question,
             category_id: $(this).closest('surveyquestion').attr("id"),
             identifier: false,
             mandatory: false
         }
     };

     resultquery = null;

     // function set_order_number_for_question(QuestionCollection) {
     //     if (_(QuestionCollection).isEmpty())
     //         return 0;
     //     else {
     //         var cu = 0;
     //         var it = _.max(QuestionCollection, function(max_item) {
     //             cu = (max_item.order_number = max_item.order_number + ORDER_NUMBER_STEP);
     //         });
     //         return cu;
     //     }
     // }

     console.dir(query);

     switch (sub_q_type) {
         case 'SingleLineQuestion':
         query.question.content = "SingleLineQuestion";
             $.post("/api/questions/", query, function(resultquery) {
                 resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                 resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                 resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                 QuestionCollection.push(resultquery);
                 var template = $('#dummy_single_line_question_template').html();
                 var str = Mustache.render(template, resultquery);
                 console.log(resultquery);
                 subquestion_this.closest('surveyquestionchild').append(str);
                 reset_builder();
             });
             break;
         case 'MultilineQuestion':
             $.post("/api/questions/", query, function(resultquery) {
                 resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                 resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                 resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                 QuestionCollection.push(resultquery);


                 var template = $('#dummy_multiline_question_template').html();
                 var str = Mustache.render(template, resultquery);

                 subquestion_this.closest('surveyquestionchild').append(str);
                 reset_builder();

             });

             break;
         case 'NumericQuestion':
             $.post("/api/questions/", query, function(resultquery) {
                 resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                 resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                 resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                 QuestionCollection.push(resultquery);


                 var template = $('#dummy_numeric_question_template').html();
                 var str = Mustache.render(template, resultquery);
                 subquestion_this.closest('surveyquestionchild').append(str);
                 reset_builder();

             });

             break;
         case 'DateQuestion':
             $.post("/api/questions/", query, function(resultquery) {
                 resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                 resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                 resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                 QuestionCollection.push(resultquery);


                 var template = $('#dummy_date_question_template').html();
                 var str = Mustache.render(template, resultquery);
                 subquestion_this.closest('surveyquestionchild').append(str);
                 reset_builder();

             });

             break;
         case 'RadioQuestion':
             $.post("/api/questions/", query, function(resultquery) {
                 resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                 resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                 resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                 QuestionCollection.push(resultquery);


                 var template = $('#dummy_radio_question_template').html();
                 var str = Mustache.render(template, resultquery);
                 subquestion_this.closest('surveyquestionchild').append(str);
                 reset_builder();

             });

             break;
         case 'MultiChoiceQuestion':
             $.post("/api/questions/", query, function(resultquery) {
                 resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                 resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                 resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                 QuestionCollection.push(resultquery);


                 var template = $('#dummy_multi_choice_question_template').html();
                 var str = Mustache.render(template, resultquery);
                 subquestion_this.closest('surveyquestionchild').append(str);
                 reset_builder();

             });

             break;
         case 'DropDownQuestion':
             $.post("/api/questions/", query, function(resultquery) {
                 resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                 resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                 resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                 QuestionCollection.push(resultquery);


                 var template = $('#dummy_drop_down_question_template').html();
                 var str = Mustache.render(template, resultquery);
                 subquestion_this.closest('surveyquestionchild').append(str);
                 reset_builder();

             });

             break;
         case 'PhotoQuestion':
             $.post("/api/questions/", query, function(resultquery) {
                 resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                 resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                 resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                 QuestionCollection.push(resultquery);


                 var template = $('#dummy_photo_question_template').html();
                 var str = Mustache.render(template, resultquery);
                 subquestion_this.closest('surveyquestionchild').append(str);
                 reset_builder();

             });

             break;
         case 'RatingQuestion':
             $.post("/api/questions/", query, function(resultquery) {
                 resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                 resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                 resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                 QuestionCollection.push(resultquery);


                 var template = $('#dummy_rating_question_template').html();
                 var str = Mustache.render(template, resultquery);
                 subquestion_this.closest('surveyquestionchild').append(str);
                 reset_builder();

             });

             break;
         case 'MultiRecordCategory':
             $.post("/api/questions/", query, function(resultquery) {
                 resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                 resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                 resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                 QuestionCollection.push(resultquery);


                 var template = $('#dummy_multi_record_category_template').html();
                 var str = Mustache.render(template, resultquery);
                 subquestion_this.closest('surveyquestionchild').append(str);


             });

             break;
         case 'CategoryQuestion':

             query = {
                 category: {
                     content: 'Untitled Category',
                     survey_id: <%= @survey.id %> ,
                     order_number: order_number_send
                 }
             };
             $.post("/api/categories/", query, function(resultquery) {
                 resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                 resultquery.duplicate_url = "/api/categories/" + resultquery.id + '/duplicate';
                 resultquery.image_upload_url = "/api/categories/" + resultquery.id + '/image_upload';
                 QuestionCollection.push(resultquery);
                 console.dir(QuestionCollection);


                 var template = $('#dummy_category_template').html();
                 var str = Mustache.render(template, resultquery);
                 subquestion_this.closest('surveyquestionchild').append(str);


             });

             break;
         default:
             $.post("/api/questions/", query, function(resultquery) {
                 resultquery.allow_identifier = (!(resultquery.parent_id) || resultquery.has_multi_record_ancestor);
                 resultquery.duplicate_url = "/api/questions/" + resultquery.id + '/duplicate';
                 resultquery.image_upload_url = "/api/questions/" + resultquery.id + '/image_upload';
                 QuestionCollection.push(resultquery);


                 var template = $('#dummy_category_template').html();
                 var str = Mustache.render(template, resultquery);
                 subquestion_this.closest('surveyquestionchild').append(str);
                 reset_builder();

             });
     }
});

// ADd sub question end
//form accordian  

    // $('.question-container').live('click', function(){
    //   $(this).next('.children-content').slideToggle(); 
    // });
    var animateAll = 0;
    $('.collapseAll-btn').live('click', function(){
      $(this).toggleClass('collapsed');      
      if(animateAll == 0){
        $('.question-row').stop().animate({height: '32px'});
        animateAll = 1; 
      }else{
        $('.question-row').stop().animate({height: '100%'});
        animateAll = 0; 
      }
      return false;

    });


    //To close add-type box clicking outside
    $(document).click(function (q)
    {
        var container = $(".addQuestion");
        var container02 = $(".settingOptionsWrp");
        var container03 = $(".question-row");
        // var container04 = $("#welcome");

        if (!container.is(q.target) // if the target of the click isn't the container...
            && container.has(q.target).length === 0) // ... nor a descendant of the container
        {
            $('.question-types').removeClass('show');
        }

        if (!container02.is(q.target) // if the target of the click isn't the container...
            && container02.has(q.target).length === 0) // ... nor a descendant of the container
        {
            $('.setting-options').removeClass('active');
            $('.settingOptionsWrp').removeClass('active');
        }

        if (!container03.is(q.target) // if the target of the click isn't the container...
            && container03.has(q.target).length === 0) // ... nor a descendant of the container
        {
            $('.question-row').css({'box-shadow':'0px 0px 0px #000',
                '-webkit-box-shadow':'0px 0px 0px #000' , '-moz-box-shadow':'0px 0px 0px #000'});
        }

        // if (!container04.is(q.target) // if the target of the click isn't the container...
        //     && container04.has(q.target).length === 0) // ... nor a descendant of the container
        // {
        //     $('.profilePopUp').hide();
        // }

    });


    $('.setting').live('click', function(){
      $('.setting-options').removeClass('active');
      $('.settingOptionsWrp').removeClass('active');

      $(this).next('.setting-options').addClass('active'); 
      $(this).parents().addClass('active');
      return false;
    });    


   // var animateNo = 0;
   //  $('.question-container').live('click', function(){

   //    if(animateNo == 0){
   //      $(this).parent().stop().animate({height: '32px'});
   //      animateNo = 1; 
   //    }else{
   //      $(this).parent().stop().animate({height: '100%'}); 
   //      animateNo = 0;
   //    }
   //  });


    //to show minus button image on add question button
      $('.add-question-btn').live('click', function(){
        //$(this).toggleClass('minusImg'); 
        $(this).prev('.question-types').toggleClass('show');
        return false;
      });

      // $('.add-option').live('click', function(){
      //   $(this).toggleClass('minusImg');        
      //   return false;
      // });

    //var refImg_val = $('img.thumb').attr('src').val();
    // refImg_val.hide();

    // if(refImg_val != null){
    //     refImg_val.show();
    // }

    // $('img[src=""]').hide();


      //selected question shadow effect
      $('.question-row').live('click',function(event){

        $('.question-row').css({'box-shadow':'0px 0px 0px #000',
                '-webkit-box-shadow':'0px 0px 0px #000' , '-moz-box-shadow':'0px 0px 0px #000'});
        $('.form-top-right-actions').hide();

        $(event.target).closest('.question-row').css({'box-shadow':'-1px 4px 30px rgba(0, 0, 0, 0.5)' ,
                        '-webkit-box-shadow':'-1px 4px 30px rgba(0, 0, 0, 0.5)' ,
                        '-moz-box-shadow':'-1px 4px 30px rgba(0, 0, 0, 0.5)'});

        $(event.target).closest('.question-row').find('.form-top-right-actions').show();
        // $(this).parents('.question-row').css('border', '2px solid red');
      });


    



  // ///
    $("#save").on('click',function(){
      var survey_object = {
        description: $("#my_org_description").val(),
        expiry_date: $(".expiry_date").val(),
        name: $("#organization_name").val()
        /*organization_logo_url: "https://surveywebproductionassets.s3.amazonaws.com/uploads/user_service/organization/ logo/23/thumb_userworks_logo.png"*/
      };
      $.ajax({
            url: "/api/surveys/" + <%= @survey.id %>,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(survey_object),
              beforeSend: function(xhr)   
                {
                  xhr.setRequestHeader("X-Http-Method-Override", "PUT");
                },
                success:function(resultquery){
                  //console.log(resultquery);
                }
          });

      console.log(QuestionCollectionToSave);
        $.each(QuestionCollection,function(key,question){
          // console.log("Curent Q type " + question.type);
        if (question.type == "MultiRecordCategory" || question.type == null) {
          console.log("saving MultiRecordCategory");
          $.ajax({
            url: "/api/categories/" + question.id,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(question),
              beforeSend: function(xhr)   
                {
                  xhr.setRequestHeader("X-Http-Method-Override", "PUT");
                },
                success:function(resultquery){
                  //console.log(resultquery);
                }
            });  
        } else {
          console.log("saving " + question.type);
        $.ajax({
            url: "/api/questions/" + question.id,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(question),
              beforeSend: function(xhr)   
                {
                  xhr.setRequestHeader("X-Http-Method-Override", "PUT");
                },
                success:function(resultquery){
                  //console.log(resultquery);
                }
          });
      } 
});
      
$.each(OptionCollection,function(key,option){

        $.ajax({
            url: "/api/options/" + option.id,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(option),
              beforeSend: function(xhr)   
                {
                  xhr.setRequestHeader("X-Http-Method-Override", "PUT");
                },
                success:function(resultquery){
                  //console.log(resultquery);
                }
          });

});
    });
  

   // $(document).find('.star').raty({
   //    readOnly: true,
   //    number: 5
   //  });
    // ///
    // 
  // var sortable_items = $(".survey-builder" ).sortable().toArray();
  // console.log("sortable_items");
   
   ///////////////////////
   function internal_sort(){
    // alert("internal_sort");
    $("surveyquestionchild" ).sortable({ 
   items : "surveyquestion", 
   containment: "parent",
    update : function(event,ui){
   var myOrder = $(this).sortable('toArray');
      myOrder = $.grep(myOrder,function(n){
        return(n);
    });
      $.each(QuestionCollection,function(key,value){
        $.each(myOrder,function(key1,value1){

          if(value.id == value1){
            value.order_number = key1 * 2;
            return false;
          }
        });
      });
      reset_builder();
    }
  });

  
   }

   

   function reinitialize_sort(){
    // alert("reinitialize_sort");
    $(".survey-builder" ).sortable({ 
   items : "> surveyquestion", 
    start : function(event,ui){
    },
    update : function (event,ui){
      var myOrder = $(this).sortable('toArray');
      myOrder = $.grep(myOrder,function(n){
        return(n);
    });
      $.each(QuestionCollection,function(key,value){
        $.each(myOrder,function(key1,value1){

          if(value.id == value1){
            value.order_number = key1 * 2;
            return false;
          }
        });
      });
      reset_builder();
      setTimeout(internal_sort, 6000);
    }  
  
  });
    setTimeout(internal_sort, 6000);
   }

    setTimeout(reinitialize_sort, 3000);
   



 });

</script>
<%= @survey.build_mustache_templates %>
